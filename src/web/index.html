<html>
	<head>
		<title>Test</title>

		<script>
			function writeMessage(source, message) {
				var responseBox = document.getElementById("chat_messages");
				// TODO Work on escaping? Do we need to?

				var messageBox = document.createElement('p');
				messageBox.append(source);
				messageBox.append(": ");
				messageBox.append(message);
				responseBox.appendChild(messageBox);
			}


			let socket = new WebSocket("ws://" + location.host + "/test");

			socket.onopen = function(e) {
				// Setup?
			};

			socket.onmessage = function(event) {
				var response = JSON.parse(event.data);
				if(response.type == "CHAT") {
					writeMessage(response.source, response.message);
				}
			};

			socket.onclose = function(event) {
				if (event.wasClean) {
					writeMessage("Network", `Connection closed cleanly: ${event.code} for ${event.reason}`);
				} else {
					writeMessage("Network", "Connection died");
				}
			};

			socket.onerror = function(error) {
				awriteMessage("Network", `Error ${error.message}`);
			};

			function chatSend() {
				var textbox = document.getElementById("chat_input_text");
				var text = textbox.value.trim();
				textbox.value = ""; // TODO Disable sending until the message come back and clear then instead
				var message = {
					"type": "CHAT",
					"message": text
				};
				socket.send(JSON.stringify(message));
			}
		</script>
		<style>
			.panel {
				border: 3px solid black;
				border-radius: 10px;
				padding: 10px
			}
			#chat_messages p {
				border: 1px solid black;
				margin: 2px;
				border-radius: 5px;
			}
			.leftPanel {
				float: left;
				width: 45%;
			}
			.rightPanel {
				float: right;
				width: 45%;
			}
			.leftPanel textarea {
				width: 100%;
			}
			.panelDone {
				clear: both;
			}
		</style>
	</head>
	<body>
		<h1>Test chat</h1>

		<div class="panel leftPanel">
			<textarea id="chat_input_text"></textarea>
			<button id="chat_input_ok" onclick="chatSend()">Send</button>
		</div>
		<div id="chat_messages" class="panel rightPanel"></div>
		<div class="panelDone"></div>
	</body>
</html>